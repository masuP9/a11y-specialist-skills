[English](./interactive-checks.md)

# インタラクティブチェック

ユーザー操作をPlaywrightで再現して判定する項目。キーボード/ポインター/エラー処理など、状態遷移が絡む基準を扱います。

## 共通手順
- 主要フローをキーボードで通過（Tab/Shift+Tab/Enter/Space/矢印）
- ポインター操作を模擬（click/drag/hover）
- DOM差分とa11y treeで状態変化を記録

## キーボード
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 2.1.1 | すべての機能をキーボードのみで実行 | 操作ログ/動画 | クリック専用操作がある |
| 2.1.2 | すべてのフォーカスを抜けられる | 操作ログ | フォーカストラップがある |
| 2.1.4 | 文字キー単独ショートカットの無効化/再割当/フォーカス限定 | 操作ログ | ショートカットが誤発火し回避不可 |

## フォーカス
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 2.4.3 | フォーカス順序が視覚順と一致 | フォーカス順ログ | 大きく順序が崩れる |
| 2.4.7 | フォーカス可視化を確認 | スクショ/動画 | フォーカスが視認不可 |
| 2.4.11 | フォーカス表示が最低要件を満たす | スクショ/計測 | コントラスト/太さが不足 |

### フォーカス可視化チェックスクリプト

`scripts/focus-indicator-check.ts` を使用して、フォーカスインジケーターの有無を自動検出できます。

**機能:**
- ページ内のフォーカス可能な要素を自動検出
- Tab キーで各要素にフォーカスを移動し、スタイル変化をキャプチャ
- フォーカス時のスタイル変化を検出（outline, box-shadow, background-color, border, transform 等）
- フォーカススタイルがない要素を赤枠と警告ラベルでマーク
- 全ページスクリーンショットで問題箇所を視覚化

**使用方法:**
```bash
# スクリプト内のURLを変更して実行
npx playwright test scripts/focus-indicator-check.ts
```

**出力:**
- `focus-indicators.png` - 問題のある要素に警告ラベルを付けた全ページスクリーンショット
- コンソール出力 - 合計要素数、フォーカススタイルあり/なしの内訳

**依存関係:**
```bash
npm install @playwright/test
```

## ポインター
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 2.5.7 | ドラッグ以外の操作手段を提供 | 操作ログ | ドラッグ必須で代替なし |
| 2.5.8 | ターゲットサイズを測定 | スクショ/計測 | 最低サイズを満たさない |

## ホバー/フォーカス表示
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 1.4.13 | ホバー/フォーカスで出るコンテンツを閉じ/保持可能 | 操作ログ/動画 | 逃げ場なし、意図せず消える |

## エラー処理
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 3.3.1 | エラー入力時に識別が提示 | スクショ | エラー箇所が不明 |
| 3.3.3 | 修正提案が表示 | スクショ | 具体的な修正提案なし |
| 3.3.4 | 重要操作の再確認/取消が可能 | 操作ログ | 取消/確認がない |

## 認証
| 基準 | 操作 | 証跡 | Fail条件 |
|---|---|---|---|
| 3.3.8 | 認証で認知負荷のみを要求しない | 画面キャプチャ | 認知テストのみで代替なし |

## 自動再生検出

対象基準:
- **1.4.2** (音声の制御): 自動再生音声を停止/制御できる
- **2.2.2** (一時停止、停止、非表示): 自動更新コンテンツを一時停止/停止できる

### 自動再生検出スクリプト

`scripts/auto-play-detection.ts` を使用して、ピクセルレベルのスクリーンショット比較による自動再生コンテンツを検出できます。

**機能:**
- 2秒間隔でスクリーンショットを撮影（0秒, 2秒, 4秒, 6秒）
- ピクセルレベルの差分検出（pixelmatch）で正確な比較
- 5秒以上コンテンツが継続するかを検出（WCAG 2.2.2 の閾値）
- ページ内の一時停止/停止コントロールを自動検出
- 一時停止コントロールをクリックして実際に機能するか検証
- 変化箇所をハイライトした差分画像を生成
- アクセシビリティ推奨事項を含むレポートを出力

**使用方法:**
```bash
# スクリプト内のURLを変更して実行
npx playwright test scripts/auto-play-detection.ts
```

**出力:**
- `auto-play-screenshots/` - 以下を含むディレクトリ:
  - `screenshot-0s.png` ～ `screenshot-6s.png` - 比較用スクリーンショット
  - `diff-*-vs-*.png` - 変化したピクセルを示す差分画像
  - `detection-result.json` - 完全な検出結果:
    - 各間隔の変化率
    - 5秒以内に停止するか
    - 検出された一時停止コントロール（アクセシビリティ情報付き）
    - 一時停止コントロールの検証結果

**依存関係:**
```bash
npm install @playwright/test pixelmatch pngjs
npm install -D @types/pngjs
```

**一時停止コントロール検出:**
スクリプトは以下の方法で一時停止/停止コントロールを自動検索します:
- 一時停止関連キーワードを含むアクセシブル名（英語/日本語対応）
- クラス名パターン（pause, play, stop, toggle, switch, control）
- コンテキスト認識（カルーセル要素近くのコントロールを優先）

**一時停止コントロール検証:**
自動再生が検出され、5秒以上継続する場合:
1. 一時停止コントロールが見つかった → クリック実行
2. クリック前後でスクリーンショットを撮影
3. 比較してアニメーションが実際に停止したか確認
4. コントロールが機能するかどうかをレポート

**制限事項:**
- 視覚的変化のみ検出（カルーセル、アニメーション、動画再生）
- 音声の自動再生は手動確認が必要（聴覚確認）
- 0.1%未満の小さなアニメーションは検出されない場合あり

**手動確認が必要な項目:**
- 一時停止/停止コントロールがキーボードでアクセス可能か確認
- 音声の自動再生を聴覚で確認（スクリーンショットでは検出不可）
- 一時停止コントロール検証が失敗した場合、手動でコントロール機能を確認
